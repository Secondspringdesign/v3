name: Supabase HTTP Smoke

on:
  push:
    branches: [staging, main]
  workflow_dispatch:

jobs:
  staging-http:
    name: Staging HTTP health
    runs-on: ubuntu-latest
    environment: Preview
    steps:
      - name: Auth health (no auth required)
        run: |
          REF="${{ secrets.STAGING_SUPABASE_PROJECT_REF }}"
          curl -fsS "https://${REF}.supabase.co/auth/v1/health" -o /dev/null
      - name: Optional REST ping (facts table) with anon key
        if: ${{ secrets.STAGING_ANON_KEY != '' }}
        env:
          REF: ${{ secrets.STAGING_SUPABASE_PROJECT_REF }}
          ANON: ${{ secrets.STAGING_ANON_KEY }}
        run: |
          curl -fsS \
            -H "apikey: $ANON" \
            -H "Authorization: Bearer $ANON" \
            "https://${REF}.supabase.co/rest/v1/facts?select=id&limit=1" \
            -o /dev/null || echo "REST ping optional: create facts table or add STAGING_ANON_KEY to enable"

  production-http:
    name: Production HTTP health
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Auth health (no auth required)
        run: |
          REF="${{ secrets.PRODUCTION_SUPABASE_PROJECT_REF }}"
          curl -fsS "https://${REF}.supabase.co/auth/v1/health" -o /dev/null
      - name: Optional REST ping (facts table) with anon key
        if: ${{ secrets.PRODUCTION_ANON_KEY != '' }}
        env:
          REF: ${{ secrets.PRODUCTION_SUPABASE_PROJECT_REF }}
          ANON: ${{ secrets.PRODUCTION_ANON_KEY }}
        run: |
          curl -fsS \
            -H "apikey: $ANON" \
            -H "Authorization: Bearer $ANON" \
            "https://${REF}.supabase.co/rest/v1/facts?select=id&limit=1" \
            -o /dev/null || echo "REST ping optional: create facts table or add PRODUCTION_ANON_KEY to enable"
