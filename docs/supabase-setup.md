# Supabase Setup Guide

This document describes the required Supabase schema and configuration for the Business Hub memory system.

## Required Tables

### documents table

The `documents` table stores business documents (business plans, marketing plans, etc.) generated by the AI agent.

```sql
-- Create documents table
CREATE TABLE IF NOT EXISTS public.documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES public.businesses(id) ON DELETE CASCADE,
  document_type TEXT NOT NULL,
  title TEXT,
  content JSONB,
  version INTEGER NOT NULL DEFAULT 1,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Create index for faster queries by business_id
CREATE INDEX IF NOT EXISTS idx_documents_business_id ON public.documents(business_id);

-- Enable Row Level Security
ALTER TABLE public.documents ENABLE ROW LEVEL SECURITY;

-- Create updated_at trigger
CREATE TRIGGER set_documents_updated_at
  BEFORE UPDATE ON public.documents
  FOR EACH ROW
  EXECUTE FUNCTION public.trigger_set_updated_at();
```

## Realtime Configuration

The following tables need to have Supabase Realtime enabled to support real-time updates in the UI:

1. **facts** - Already enabled ✓
2. **planner** - Needs to be enabled
3. **goals** - Needs to be enabled
4. **documents** - Needs to be enabled

### Enable Realtime via Supabase Dashboard

1. Go to your Supabase project dashboard
2. Navigate to Database → Replication
3. Enable Realtime for the following tables:
   - `planner`
   - `goals`
   - `documents`

### Enable Realtime via SQL (Alternative)

```sql
-- Enable Realtime replication for planner table
ALTER PUBLICATION supabase_realtime ADD TABLE public.planner;

-- Enable Realtime replication for goals table
ALTER PUBLICATION supabase_realtime ADD TABLE public.goals;

-- Enable Realtime replication for documents table
ALTER PUBLICATION supabase_realtime ADD TABLE public.documents;
```

## Migration Script

If you prefer to add the documents table via a migration file, create a new migration:

```bash
# Create migration file
supabase migration new add_documents_table
```

Then add the SQL from the "documents table" section above to the new migration file and run:

```bash
supabase db push
```

## Verification

To verify the setup:

1. Check that the `documents` table exists:
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public' AND table_name = 'documents';
   ```

2. Verify Realtime is enabled:
   ```sql
   SELECT schemaname, tablename 
   FROM pg_publication_tables 
   WHERE pubname = 'supabase_realtime';
   ```

   Should return rows for: `facts`, `planner`, `goals`, `documents`

## Schema Reference

The `documents` table schema (from `lib/types/database.ts`):

```typescript
export interface DbDocument {
  id: string;                          // UUID primary key
  business_id: string;                 // FK → businesses.id
  document_type: string;               // e.g., "business_plan", "marketing_plan"
  title: string | null;                // Document title
  content: Record<string, unknown> | null;  // JSON content
  version: number;                     // Version number (default: 1)
  created_at: string;                  // ISO timestamp
  updated_at: string;                  // ISO timestamp
}
```
